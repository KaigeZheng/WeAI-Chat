<!--index.wxml-->
<view class="chat-container {{themeClass}}" data-theme="{{pageTheme}}" bindtap="onPageTap">
  <!-- å®‰å…¨åŒºåŸŸé€‚é… -->
  <view class="safe-area-top"></view>
  
  <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
  <view class="header">
    <view class="header-content">
      <view class="title-section">
        <text class="title">WeAI Chat</text>
        <text class="service-indicator">{{currentService === 'qwen' ? 'Qwen-Plus' : 'DeepSeek'}}</text>
      </view>
      <view class="header-actions">
        <view class="rect-btn settings-btn" bindtap="goToSettings">
          <text class="btn-text">è®¾ç½®</text>
        </view>
        <view class="rect-btn clear-btn" bindtap="clearChat">
          <text class="btn-text">æ¸…ç©º</text>
        </view>
        <view class="user-avatar" bindtap="goToUserProfile">
          <image wx:if="{{userInfo.avatarUrl}}" class="avatar-image" src="{{userInfo.avatarUrl}}" mode="aspectFill"></image>
          <view wx:else class="avatar-placeholder">
            <text class="avatar-text">ğŸ‘¤</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- æ¶ˆæ¯åˆ—è¡¨åŒºåŸŸ -->
  <scroll-view 
    class="message-list" 
    scroll-y="true" 
    scroll-into-view="{{scrollToMessage}}"
    scroll-with-animation="true"
    enhanced="true"
    show-scrollbar="false"
  >
    <view class="message-list-content">
      <!-- æ¬¢è¿æ¶ˆæ¯ -->
      <view wx:if="{{messages.length === 0}}" class="welcome-message">
        <view class="welcome-icon">ğŸ¤–</view>
        <text class="welcome-text">ä½ å¥½ï¼æˆ‘æ˜¯WeAI Chatï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ</text>
      </view>
      
      <!-- æ¶ˆæ¯åˆ—è¡¨ -->
      <view 
        wx:for="{{messages}}" 
        wx:key="id" 
        class="message-item {{item.role === 'user' ? 'user-message' : 'ai-message'}}"
        id="msg-{{item.id}}"
      >
        <view class="message-avatar">
          <image wx:if="{{item.role === 'user' && userInfo.avatarUrl}}" class="avatar-image" src="{{userInfo.avatarUrl}}" mode="aspectFill"></image>
          <view wx:else class="avatar-placeholder">
            <text class="avatar-text">{{item.role === 'user' ? 'ğŸ‘¤' : (item.model === 'qwen' ? 'Q' : 'D')}}</text>
          </view>
        </view>
        <view class="message-content">
          <view class="message-header">
            <text class="message-id">{{item.role === 'user' ? item.userId : (item.model === 'qwen' ? 'Qwen-Plus' : 'DeepSeek')}}</text>
            <text class="message-time">{{item.time}}</text>
          </view>
          <view class="message-bubble">
            <towxml wx:if="{{item.role === 'assistant' && item.content}}" nodes="{{item.towxmlNodes}}" wx:key="content"></towxml>
            <text wx:if="{{item.role === 'assistant' && !item.content}}" class="message-text">æ­£åœ¨æ€è€ƒä¸­</text>
            <text wx:if="{{item.role === 'user'}}" class="message-text" user-select="true">{{item.content}}</text>
            <view wx:if="{{item.isStreaming}}" class="streaming-indicator">
              <view class="streaming-dot"></view>
              <view class="streaming-dot"></view>
              <view class="streaming-dot"></view>
            </view>
          </view>
          
          <!-- AIæ¶ˆæ¯çš„å¤åˆ¶æŒ‰é’® -->
          <view wx:if="{{item.role === 'assistant' && item.content && !item.isStreaming}}" class="copy-actions">
            <view class="copy-btn" data-type="text" data-content="{{item.content}}" bindtap="copyMessage">
              <text class="copy-icon">ğŸ“‹</text>
              <text class="copy-text">å¤åˆ¶æ–‡æœ¬</text>
            </view>
            <view class="copy-btn" data-type="markdown" data-content="{{item.content}}" bindtap="copyMessage">
              <text class="copy-icon">ğŸ“</text>
              <text class="copy-text">å¤åˆ¶Markdown</text>
            </view>
          </view>
        </view>
      </view>
    </view>
  </scroll-view>

  <!-- åº•éƒ¨è¾“å…¥åŒºåŸŸ -->
  <view class="input-container">
    <!-- å¯¹è¯é£æ ¼é€‰æ‹©å™¨ -->
    <view class="style-selector" catchtap="onStyleSelectorTap">
      <view class="current-style" bindtap="toggleStyleMenu">
        <view class="style-icon">{{styleConfigs[currentStyle].icon}}</view>
        <text class="style-name">{{styleConfigs[currentStyle].name}}</text>
        <view class="style-arrow {{showStyleMenu ? 'rotate' : ''}}">â–¼</view>
      </view>
      
      <!-- é£æ ¼é€‰æ‹©èœå• -->
      <view class="style-menu {{showStyleMenu ? 'show' : ''}}" wx:if="{{showStyleMenu}}">
        <view 
          wx:for="{{styleConfigs}}" 
          wx:key="key"
          class="style-option {{currentStyle === item.key ? 'active' : ''}}"
          data-style="{{item.key}}"
          bindtap="selectStyle"
        >
          <view class="style-option-icon">{{item.icon}}</view>
          <view class="style-option-content">
            <text class="style-option-name">{{item.name}}</text>
            <text class="style-option-desc">{{item.description}}</text>
          </view>
          <view class="style-option-check" wx:if="{{currentStyle === item.key}}">âœ“</view>
        </view>
      </view>
    </view>
    
    <view class="input-wrapper">
      <textarea 
        class="message-input" 
        placeholder="{{styleConfigs[currentStyle].placeholder}}" 
        value="{{inputMessage}}"
        bindinput="onInputChange"
        bindconfirm="sendMessage"
        auto-height="true"
        maxlength="1000"
        show-confirm-bar="false"
        cursor-spacing="10"
        adjust-position="true"
        hold-keyboard="false"
        disable-default-padding="true"
      ></textarea>
      <view class="send-btn {{hasInputContent ? 'active' : ''}}" bindtap="sendMessage">
        <text class="send-icon">å‘é€</text>
      </view>
    </view>
  </view>
  
  <!-- å®‰å…¨åŒºåŸŸé€‚é… -->
  <view class="safe-area-bottom"></view>
</view>
