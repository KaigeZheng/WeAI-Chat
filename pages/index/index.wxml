<!--index.wxml-->
<view class="chat-container {{themeClass}}" data-theme="{{pageTheme}}">
  <!-- å®‰å…¨åŒºåŸŸé€‚é… -->
  <view class="safe-area-top"></view>
  
  <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
  <view class="header">
    <view class="header-content">
      <view class="title-section">
        <text class="title">WeAI Chat</text>
        <text class="service-indicator">{{currentService === 'qwen' ? 'Qwen-Plus' : 'DeepSeek'}}</text>
      </view>
      <view class="header-actions">
        <view class="rect-btn settings-btn" bindtap="goToSettings">
          <text class="btn-text">è®¾ç½®</text>
        </view>
        <view class="rect-btn clear-btn" bindtap="clearChat">
          <text class="btn-text">æ¸…ç©º</text>
        </view>
        <view class="user-avatar" bindtap="goToUserProfile">
          <image wx:if="{{userInfo.avatarUrl}}" class="avatar-image" src="{{userInfo.avatarUrl}}" mode="aspectFill"></image>
          <view wx:else class="avatar-placeholder">
            <text class="avatar-text">ğŸ‘¤</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- æ¶ˆæ¯åˆ—è¡¨åŒºåŸŸ -->
  <scroll-view 
    class="message-list" 
    scroll-y="true" 
    scroll-into-view="{{scrollToMessage}}"
    scroll-with-animation="true"
    enhanced="true"
    show-scrollbar="false"
  >
    <view class="message-list-content">
      <!-- æ¬¢è¿æ¶ˆæ¯ -->
      <view wx:if="{{messages.length === 0}}" class="welcome-message">
        <view class="welcome-icon">ğŸ¤–</view>
        <text class="welcome-text">ä½ å¥½ï¼æˆ‘æ˜¯WeAI Chatï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ</text>
      </view>
      
      <!-- æ¶ˆæ¯åˆ—è¡¨ -->
      <view 
        wx:for="{{messages}}" 
        wx:key="id" 
        class="message-item {{item.role === 'user' ? 'user-message' : 'ai-message'}}"
        id="msg-{{item.id}}"
      >
        <view class="message-avatar">
          <image wx:if="{{item.role === 'user' && userInfo.avatarUrl}}" class="avatar-image" src="{{userInfo.avatarUrl}}" mode="aspectFill"></image>
          <view wx:else class="avatar-placeholder">
            <text class="avatar-text">{{item.role === 'user' ? 'ğŸ‘¤' : (item.model === 'qwen' ? 'Q' : 'D')}}</text>
          </view>
        </view>
        <view class="message-content">
          <view class="message-bubble">
            <wemark wx:if="{{item.role === 'assistant' && item.content}}" md="{{item.content}}" link highlight wx:key="content"></wemark>
            <text wx:if="{{item.role === 'assistant' && !item.content}}" class="message-text">æ­£åœ¨æ€è€ƒä¸­...</text>
            <text wx:if="{{item.role === 'user'}}" class="message-text" user-select="true">{{item.content}}</text>
            <view wx:if="{{item.isStreaming}}" class="streaming-indicator">
              <view class="streaming-dot"></view>
              <view class="streaming-dot"></view>
              <view class="streaming-dot"></view>
            </view>
          </view>
          <view class="message-time">{{item.time}}</view>
        </view>
      </view>
    </view>
  </scroll-view>

  <!-- åº•éƒ¨è¾“å…¥åŒºåŸŸ -->
  <view class="input-container">
    <view class="input-wrapper">
      <textarea 
        class="message-input" 
        placeholder="è¾“å…¥ä½ çš„é—®é¢˜..." 
        value="{{inputMessage}}"
        bindinput="onInputChange"
        bindconfirm="sendMessage"
        auto-height="true"
        maxlength="1000"
        show-confirm-bar="false"
        cursor-spacing="10"
        adjust-position="true"
        hold-keyboard="false"
        disable-default-padding="true"
      ></textarea>
      <view class="send-btn {{inputMessage.trim() ? 'active' : ''}}" bindtap="sendMessage">
        <text class="send-icon">å‘é€</text>
      </view>
    </view>
  </view>
  
  <!-- å®‰å…¨åŒºåŸŸé€‚é… -->
  <view class="safe-area-bottom"></view>
</view>
